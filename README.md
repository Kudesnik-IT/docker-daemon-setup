### Docker Daemon Configuration Script (DDCS)

#### Описание
Этот скрипт автоматизирует процесс настройки конфигурационного файла **Docker Daemon (`daemon.json`)**.

Скрипт выполняет следующие задачи:
- Создает файл `/etc/docker/daemon.json` с указанными параметрами.
- Делает резервную копию существующего файла `daemon.json`, если он уже существует.
- Перезапускает службу Docker и проверяет статус Docker после перезапуска.

---

### Основные функции

1. **Настройка `daemon.json`:**
   - Управление правилами `iptables`.
   - Включение режима восстановления (`live-restore`) для предотвращения остановки контейнеров при перезапуске Docker.
   - Настройка базового IP-адреса и пула адресов для сетей Docker.
   - Отключение поддержки IPv6.

2. **Безопасность:**
   - Перед созданием нового файла делается резервная копия текущего `daemon.json`.
   - Все операции выполняются с проверкой ошибок для надежности.

---

### Зависимости

Для корректной работы скрипта требуются следующие компоненты:
- **Bash** (версии 4.0+)
- **Docker** (версии 20.10+)
- **Coreutils** (для команд `cp`, `echo`, `sleep` и т.д.)
- **Systemd** (для управления службой Docker)

---

### Инструкции по использованию

1. **Скачайте скрипт:**
   ```bash
   wget [https://github.com/your-repo/docker-daemon-config/raw/main/docker_daemon_config.sh](https://raw.githubusercontent.com/Kudesnik-IT/docker-daemon-setup/refs/heads/main/docker_setup.sh)
   ```

2. **Сделайте скрипт исполняемым:**
   ```bash
   chmod +x docker_setup.sh
   ```

3. **Запустите скрипт с правами root:**
   ```bash
   sudo ./docker_setup.sh
   ```

4. **Проверьте изменения:**
   После выполнения скрипта вы можете проверить содержимое файла `/etc/docker/daemon.json` и убедиться, что Docker работает корректно:
   ```bash
   cat /etc/docker/daemon.json
   systemctl status docker
   ```

---

### Пример конфигурации `daemon.json` с описанием параметров

После выполнения скрипта файл `/etc/docker/daemon.json` будет выглядеть примерно так:

```json
{
  "iptables": true,
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "default-runtime": "runc",
  "live-restore": true,
  "bip": "192.168.2.254/27",
  "ipv6": false,
  "fixed-cidr": "192.168.2.0/27",
  "default-address-pools": [
    {
      "base": "192.168.2.0/24",
      "size": 27
    }
  ],
  "oom-score-adjust": -500,
  "default-ulimits": {
    "nofile": { "Name": "nofile", "Hard": 65535, "Soft": 65535 },
    "nproc": { "Name": "nproc", "Hard": 65535, "Soft": 65535 }
  }
}
```

#### Описание каждого параметра:



#### 1. `"iptables": true`
- **Описание:** Указывает Docker автоматически добавлять свои правила в `iptables` для маршрутизации трафика.
- **Значение `true`:** Docker управляет сетевыми правилами через `iptables`.
- **Значение `false`:** Управление сетевыми правилами самостоятельно.

#### 2. `"log-driver": "json-file"`
- **Описание:** Устанавливает драйвер логирования для всех контейнеров.
- **Значение `json-file`:** Логи сохраняются в формате JSON в файлах на диске.
- **Преимущества:** Формат JSON удобен для анализа с помощью инструментов сбора логов (например, ELK Stack).

#### 3. `"log-opts": { "max-size": "10m", "max-file": "3" }`
- **Описание:** Настройки ограничений для логов:
  - `"max-size": "10m"`: Максимальный размер одного файла логов — 10 MB.
  - `"max-file": "3"`: Максимальное количество файлов логов для каждого контейнера — 3.
- **Цель:** Предотвращает бесконтрольный рост логов и экономит место на диске.

#### 4. `"storage-driver": "overlay2"`
- **Описание:** Устанавливает драйвер хранения для управления файловой системой контейнеров.
- **Значение `overlay2`:** Современный драйвер, основанный на OverlayFS, обеспечивающий высокую производительность и эффективное использование дискового пространства.
- **Рекомендация:** Используйте `overlay2`, если система поддерживает OverlayFS (Linux kernel ≥ 4.0).

#### 5. `"default-runtime": "runc"`
- **Описание:** Устанавливает стандартный runtime для выполнения контейнеров.
- **Значение `runc`:** Стандартный runtime, реализующий спецификацию OCI (Open Container Initiative).
- **Цель:** Обеспечивает базовую изоляцию и управление ресурсами для контейнеров.

#### 6. `"live-restore": true`
- **Описание:** Включает режим восстановления (`live-restore`), позволяющий контейнерам продолжать работу при перезапуске службы Docker.
- **Значение `true`:** Контейнеры не будут остановлены при перезапуске Docker.
- **Цель:** Минимизирует простои в производственной среде.

#### 7. `"bip": "192.168.2.254/27"`
- **Описание:** Устанавливает базовый IP-адрес для интерфейса `docker0` и маску подсети.
- **Значение `192.168.2.254/27`:** Назначает IP-адрес `192.168.2.254` с маской `/27` (30 доступных IP-адресов) для сети Docker.
- **Цель:** Контролирует диапазон IP-адресов, используемых контейнерами.

#### 8. `"ipv6": false`
- **Описание:** Отключает поддержку IPv6 для Docker.
- **Значение `false`:** IPv6 не используется.
- **Цель:** Если ваша инфраструктура не требует IPv6, его можно отключить для упрощения конфигурации.

#### 9. `"fixed-cidr": "192.168.2.0/27"`
- **Описание:** Ограничивает диапазон IP-адресов, которые могут быть назначены контейнерам.
- **Значение `192.168.2.0/27`:** Ограничивает IP-адреса контейнеров подсетью `192.168.2.0/27` (30 доступных IP-адресов).
- **Цель:** Предотвращает конфликты IP-адресов с другими сетями.

#### 10. `"default-address-pools": [ { "base": "192.168.2.0/24", "size": 27 } ]`
- **Описание:** Создает пул IP-адресов для новых сетей Docker.
- **Значение:**
  - `"base": "192.168.2.0/24"`: Базовая подсеть для пула адресов.
  - `"size": 27`: Размер каждой подсети — `/27` (30 доступных IP-адресов).
- **Цель:** Эффективно управляет IP-адресами для различных сетей Docker.

#### 11. `"oom-score-adjust": -500`
- **Описание:** Снижает приоритет завершения Docker-демона при нехватке памяти.
- **Значение `-500`:** Делает Docker менее вероятным кандидатом для завершения в случае OOM (Out-of-Memory).
- **Цель:** Защищает Docker-демон от случайного завершения в критических ситуациях.

#### 12. `"default-ulimits": { "nofile": { "Name": "nofile", "Hard": 65535, "Soft": 65535 }, "nproc": { "Name": "nproc", "Hard": 65535, "Soft": 65535 } }`
- **Описание:** Устанавливает ограничения на использование ресурсов для всех контейнеров:
  - `"nofile"`: Ограничивает максимальное количество открытых файлов.
    - `"Hard": 65535`: Максимальное значение.
    - `"Soft": 65535`: Текущее значение.
  - `"nproc"`: Ограничивает максимальное количество процессов.
    - `"Hard": 65535`: Максимальное значение.
    - `"Soft": 65535`: Текущее значение.
- **Цель:** Предотвращает злоупотребление ресурсами одним контейнером, защищая систему от перегрузки.

---

### История изменений

- **v1.0 (2023-11-15):** Первая версия скрипта.

---

### Лицензия

Скрипт распространяется под лицензией **MIT License**. Вы можете свободно использовать, копировать, модифицировать и распространять его.

---

### Спасибо за использование!

Если у вас есть вопросы, предложения или идеи для улучшения, пожалуйста, откройте issue или отправьте pull request. 

[GitHub Repository](https://github.com/Kudesnik-IT/docker-daemon-setup)  
Автор: Kudesnik-IT <kudesnik.it@gmail.com>
